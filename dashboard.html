<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>VG Cargo Dashboard</title>
  <script>
    if (localStorage.getItem("authorized") !== "1") {
      window.location.href = "/login.html";
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #eef; display: flex; gap: 20px; padding: 20px; }
    .main, .calendar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .main { flex: 2; }
    .calendar { flex: 1; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #007BFF; color: white; }
    .summary, .info { margin-top: 10px; font-size: 14px; }
    .summary { text-align: right; font-weight: bold; }
    .calendar-table { margin-bottom: 20px; }
    td.marked { background: #ffc107; font-weight: bold; cursor: help; }
    .modal {
      display: none; position: fixed; top: 10%; left: 50%;
      transform: translateX(-50%); background: white; border-radius: 10px;
      padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 1000; width: 600px; max-height: 80vh; overflow-y: auto;
    }
    .modal input, .modal textarea { width: 100%; padding: 6px; margin: 5px 0 10px; }
    .modal label { font-weight: bold; }
    .modal button { padding: 6px 12px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-close { background: #ccc; }
    .btn-save { background: #28a745; color: white; }
    button.delete-btn {
      padding: 6px 14px; font-size: 14px;
      background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .actions { margin: 10px 0; }
  </style>
</head>
<body>
<div class="main">
  <h2>Charter Dashboard</h2>
  <div class="info">
    <span id="currentDate">Date: --</span> | <span id="clock">Time: --:--:--</span>
  </div>
  <div class="actions">
    <button onclick="exportCSV()">Export CSV</button>
    <button onclick="exportJSON()">Export JSON</button>
  </div>
  <div>
    <label>Ref:</label> <input type="text" id="refSearch" onkeyup="filterTable()" />
    <label>Airline:</label> <input type="text" id="airlineSearch" onkeyup="filterTable()" />
  </div>
  <div class="summary" id="summaryInfo">Total Flights: 0 | Total Tonnage: 0 kg</div>
  <table><thead><tr><th>Ref</th><th>Date</th><th>Airline</th><th>Tonnage</th><th>Action</th></tr></thead><tbody id="dataTable"></tbody></table>
</div>

<div class="calendar">
  <div><button onclick="shiftCalendar(-1)">←</button> <button onclick="shiftCalendar(1)">→</button></div>
  <div id="calendarArea"></div>
</div>

<div id="modal" class="modal">
  <h3>Details & Bearbeiten</h3>
  <form id="editForm">
    <input type="hidden" id="ref" />
    <label>Airline</label><input id="airline" />
    <label>Datum</label><input id="date" type="date" />
    <label>Tonnage</label><input id="tonnage" type="number" />
    <label>Firma</label><input id="billingCompany" />
    <label>Adresse</label><input id="billingAddress" />
    <label>Steuernummer</label><input id="taxNumber" />
    <label>Kontaktname</label><input id="contactName" />
    <label>Kontakt E-Mail</label><input id="contactEmail" />
    <label>Email Request</label><textarea id="emailRequest"></textarea>
    <button type="button" class="btn-save" onclick="saveChanges()">Speichern</button>
    <button type="button" class="btn-close" onclick="closeModal()">Schließen</button>
  </form>
</div>

<script>
let requestData = [];

function loadData() {
  fetch('/data/data.json')
    .then(res => res.json())
    .then(data => {
      requestData = data;
      populateRows();
    });
}

function populateRows() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  requestData.forEach((r, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `<td><a href="#" onclick="editRow(${i})">${r.ref}</a></td>
      <td>${r.date || r.flightDate || ""}</td><td>${r.airline || ""}</td>
      <td>${r.tonnage || ""}</td>
      <td><button class="delete-btn" onclick="deleteRequest('${r.ref}')">Delete</button></td>`;
    table.appendChild(row);
  });
  filterTable(); renderCalendars();
}

function editRow(index) {
  const r = requestData[index];
  document.getElementById("ref").value = r.ref || "";
  document.getElementById("airline").value = r.airline || "";
  document.getElementById("date").value = r.date || r.flightDate || "";
  document.getElementById("tonnage").value = r.tonnage || "";
  document.getElementById("billingCompany").value = r.billingCompany || "";
  document.getElementById("billingAddress").value = r.billingAddress || "";
  document.getElementById("taxNumber").value = r.taxNumber || "";
  document.getElementById("contactName").value = r.contactName || "";
  document.getElementById("contactEmail").value = r.contactEmail || "";
  document.getElementById("emailRequest").value = r.emailRequest || "";
  document.getElementById("modal").style.display = "block";
}

function closeModal() { document.getElementById("modal").style.display = "none"; }

function saveChanges() {
  const ref = document.getElementById("ref").value;
  const entry = requestData.find(r => r.ref === ref);
  if (entry) {
    entry.airline = document.getElementById("airline").value;
    entry.date = document.getElementById("date").value;
    entry.tonnage = parseInt(document.getElementById("tonnage").value) || 0;
    entry.billingCompany = document.getElementById("billingCompany").value;
    entry.billingAddress = document.getElementById("billingAddress").value;
    entry.taxNumber = document.getElementById("taxNumber").value;
    entry.contactName = document.getElementById("contactName").value;
    entry.contactEmail = document.getElementById("contactEmail").value;
    entry.emailRequest = document.getElementById("emailRequest").value;
    populateRows(); closeModal();
  }
}

function deleteRequest(ref) {
  if (confirm("Diesen Eintrag löschen?")) {
    const i = requestData.findIndex(r => r.ref === ref);
    if (i !== -1) requestData.splice(i, 1);
    populateRows();
  }
}

function filterTable() {
  const refVal = document.getElementById("refSearch").value.toLowerCase();
  const airlineVal = document.getElementById("airlineSearch").value.toLowerCase();
  const rows = document.querySelectorAll("#dataTable tr");
  let totalFlights = 0, totalTonnage = 0;
  rows.forEach(row => {
    const cells = row.children;
    const ref = cells[0].textContent.toLowerCase();
    const airline = cells[2].textContent.toLowerCase();
    const tonnage = parseFloat(cells[3].textContent.replace(/,/g, ""));
    const show = (!refVal || ref.includes(refVal)) && (!airlineVal || airline.includes(airlineVal));
    row.style.display = show ? "" : "none";
    if (show) { totalFlights++; totalTonnage += tonnage; }
  });
  document.getElementById("summaryInfo").textContent = `Total Flights: ${totalFlights} | Total Tonnage: ${totalTonnage.toLocaleString()} kg`;
}

let calendarBase = new Date();
function shiftCalendar(offset) {
  calendarBase.setMonth(calendarBase.getMonth() + offset);
  renderCalendars();
}

function renderCalendars() {
  const c = document.getElementById("calendarArea"); c.innerHTML = "";
  for (let i = 0; i < 2; i++) {
    const d = new Date(calendarBase.getFullYear(), calendarBase.getMonth() + i);
    c.innerHTML += generateCalendar(d.getFullYear(), d.getMonth());
  }
}

function generateCalendar(year, month) {
  const days = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const mName = new Date(year, month).toLocaleString('default', { month: 'long' });
  let html = `<div class="calendar-table"><h4>${mName} ${year}</h4><table><thead><tr><th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th></tr></thead><tbody>`;
  let day = 1, started = false;
  for (let i = 0; i < 6; i++) {
    html += "<tr>";
    for (let j = 1; j <= 7; j++) {
      const realDay = (j + 6) % 7;
      if (!started && realDay === firstDay) started = true;
      if (started && day <= days) {
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const match = requestData.find(x => (x.date || x.flightDate) === dateStr);
        const tooltip = match ? `${match.ref}
${match.airline}
${match.tonnage} kg` : "";
        const marked = match ? "marked" : "";
        html += `<td class="${marked}" title="${tooltip}">${day}</td>`;
        day++;
      } else { html += "<td></td>"; }
    }
    html += "</tr>";
    if (day > days) break;
  }
  html += "</tbody></table></div>";
  return html;
}

function exportCSV() {
  if (!requestData.length) return;
  const rows = [Object.keys(requestData[0])];
  requestData.forEach(obj => rows.push(Object.values(obj)));
  const csv = rows.map(r => r.map(field => `"${(field ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
  downloadFile("charter_export.csv", csv, "text/csv");
}

function exportJSON() {
  const json = JSON.stringify(requestData, null, 2);
  downloadFile("charter_export.json", json, "application/json");
}

function downloadFile(filename, content, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function updateClock() {
  const now = new Date();
  document.getElementById("clock").textContent = "Time: " + now.toTimeString().substr(0, 8);
  document.getElementById("currentDate").textContent = "Date: " + now.toISOString().substr(0, 10);
}

setInterval(updateClock, 1000);
updateClock();
loadData();
</script>
</body></html>
